{
    "name": "Akıllı Müşteri İçgörü Asistanı v2.7 - CORS Fix",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "f5d4c49e-b8f6-42d4-a019-8e6b6429d313",
                "responseMode": "responseNode",
                "options": {
                    "responseHeaders": {
                        "entries": [
                            {
                                "name": "Access-Control-Allow-Origin",
                                "value": "*"
                            },
                            {
                                "name": "Access-Control-Allow-Headers",
                                "value": "Content-Type, ngrok-skip-browser-warning"
                            },
                            {
                                "name": "Access-Control-Allow-Methods",
                                "value": "POST, OPTIONS"
                            }
                        ]
                    }
                }
            },
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2.1,
            "position": [
                200,
                240
            ],
            "id": "f99b9321-4fce-4661-922c-ee29cf6c021d",
            "name": "Webhook",
            "webhookId": "f5d4c49e-b8f6-42d4-a019-8e6b6429d313"
        },
        {
            "parameters": {
                "httpMethod": "GET",
                "path": "stats",
                "responseMode": "responseNode",
                "options": {
                    "responseHeaders": {
                        "entries": [
                            {
                                "name": "Access-Control-Allow-Origin",
                                "value": "*"
                            },
                            {
                                "name": "Access-Control-Allow-Headers",
                                "value": "Content-Type, ngrok-skip-browser-warning"
                            }
                        ]
                    }
                }
            },
            "name": "Stats Webhook",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2,
            "position": [
                200,
                500
            ],
            "id": "f5d4c49e-b8f6-42d4-a019-8e6b6429d314",
            "webhookId": "stats"
        },
        {
            "parameters": {
                "httpMethod": "OPTIONS",
                "path": "f5d4c49e-b8f6-42d4-a019-8e6b6429d313",
                "responseMode": "responseNode",
                "options": {}
            },
            "name": "Preflight Options",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2,
            "position": [
                200,
                80
            ],
            "id": "preflight-options-node",
            "webhookId": "f5d4c49e-b8f6-42d4-a019-8e6b6429d313"
        },
        {
            "parameters": {
                "respondWith": "text",
                "responseBody": "OK",
                "options": {
                    "responseHeaders": {
                        "entries": [
                            {
                                "name": "Access-Control-Allow-Origin",
                                "value": "*"
                            },
                            {
                                "name": "Access-Control-Allow-Headers",
                                "value": "Content-Type, ngrok-skip-browser-warning"
                            },
                            {
                                "name": "Access-Control-Allow-Methods",
                                "value": "POST, OPTIONS"
                            }
                        ]
                    }
                }
            },
            "name": "Respond Preflight",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                400,
                80
            ],
            "id": "respond-preflight-node"
        },
        {
            "parameters": {
                "assignments": {
                    "assignments": [
                        {
                            "id": "5d5dce59-1c08-4233-a240-59bf49028241",
                            "name": "name",
                            "value": "={{ $json.body.name}}",
                            "type": "string"
                        },
                        {
                            "id": "91514ee0-93cc-4316-9267-61690c9da3a2",
                            "name": "email",
                            "value": "={{ $json.body.email}}",
                            "type": "string"
                        },
                        {
                            "id": "f7598411-442d-4d92-9fc9-8ca6b04dbb61",
                            "name": "review",
                            "value": "={{ $json.body.review }}",
                            "type": "string"
                        },
                        {
                            "id": "f7598411-442d-4d92-9fc9-8ca6b04dbb62",
                            "name": "tone",
                            "value": "={{ $json.body.tone || 'friendly' }}",
                            "type": "string"
                        }
                    ]
                },
                "options": {}
            },
            "name": "Save Original Data",
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                400,
                240
            ],
            "id": "65ad684a-c08c-487e-8d60-512b797008e7"
        },
        {
            "parameters": {
                "assignments": {
                    "assignments": [
                        {
                            "id": "faq_content",
                            "name": "faq",
                            "value": "Şirket Bilgileri:\n- Adres: Teknoloji Plaza, İstanbul\n- Çalışma: 09:00-18:00\n- İade: 14 gün\n- Garanti: 2 yıl\n- Kargo: 500 TL üzeri ücretsiz\n- Destek: Youtube 'Kurulum Rehberi'",
                            "type": "string"
                        }
                    ]
                },
                "options": {}
            },
            "name": "Knowledge Base (FAQ)",
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                600,
                100
            ],
            "id": "faq_001",
            "notice": "Burası şirket bilgilerinizin olduğu yerdir."
        },
        {
            "parameters": {
                "operation": "read",
                "documentId": {
                    "__rl": true,
                    "value": "1CcQbucGVUjc-KT4O4noLwQ8dTJVdBR8qQ8loJkdWS7I",
                    "mode": "list"
                },
                "sheetName": {
                    "__rl": true,
                    "value": "gid=0",
                    "mode": "list"
                },
                "filters": {
                    "conditions": [
                        {
                            "id": "7662c19a-3f62-473d-815d-85fbf80e608d",
                            "leftValue": "Email",
                            "rightValue": "={{ $node[\"Save Original Data\"].json.email }}",
                            "operator": "equal"
                        }
                    ]
                },
                "options": {}
            },
            "name": "Lookup History",
            "type": "n8n-nodes-base.googleSheets",
            "typeVersion": 4,
            "position": [
                600,
                340
            ],
            "id": "e9a0b1c0-d6ef-463d-b37c-961c21bddf8e",
            "credentials": {
                "googleSheetsOAuth2Api": {
                    "id": "wqKil85WMWsXWztO",
                    "name": "Google Sheets account"
                }
            },
            "alwaysOutputData": true
        },
        {
            "parameters": {
                "jsCode": "const history = $input.all();\nif (history.length === 0 || !history[0].json.Timestamp) {\n  return [{ json: { history_text: \"İlk temas.\" } }];\n}\nconst summary = history.slice(-3).map(h => `- [${h.json.Timestamp}] Duygu: ${h.json.Sentiment}, Yorum: ${h.json.Review}`).join('\\n');\nreturn [{ json: { history_text: \"Son 3 yorum:\\n\" + summary } }];"
            },
            "name": "Format History",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                800,
                340
            ],
            "id": "c7a0b1c0-d6ef-463d-b37c-961c21bddf8e"
        },
        {
            "parameters": {
                "mode": "combine",
                "combineBy": "combineByPosition",
                "options": {}
            },
            "type": "n8n-nodes-base.merge",
            "typeVersion": 3.2,
            "position": [
                1000,
                240
            ],
            "id": "f7a0b1c0-d6ef-463d-b37c-961c21bddf8e",
            "name": "Merge Data"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $json.review }}",
                "hasOutputParser": true,
                "messages": {
                    "messageValues": [
                        {
                            "type": "HumanMessagePromptTemplate",
                            "message": "=Sen Türkiye'nin en bilgili müşteri asistanısın. \n\nŞİRKET BİLGİLERİ (FAQ):\n{{ $json.faq }}\n\nMÜŞTERİ GEÇMİŞİ:\n{{ $json.history_text }}\n\nİstenen Cevap Tonu: {{ $json.tone.toUpperCase() }}\n\nMüşteri Yorumu:\n{{ $json.review }}\n\nLütfen sadece JSON formatında cevap ver:\n{\n  \"sentiment\": \"positive\" | \"negative\" | \"neutral\" | \"inappropriate\",\n  \"sentiment_score\": 0-100,\n  \"summary\": \"Özet\",\n  \"suggested_reply\": \"Cevap (Yukarıdaki FAQ bilgilerini kullanarak net cevap ver.)\"\n}"
                        }
                    ]
                }
            },
            "type": "@n8n/n8n-nodes-langchain.chainLlm",
            "typeVersion": 1.7,
            "position": [
                1200,
                240
            ],
            "id": "2d1f0bcb-d6ef-463d-b37c-961c21bddf8e",
            "name": "Basic LLM Chain"
        },
        {
            "parameters": {
                "model": "llama-3.3-70b-versatile",
                "options": {
                    "temperature": 0.2
                }
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatGroq",
            "typeVersion": 1,
            "position": [
                1200,
                420
            ],
            "id": "cb25c02a-3e3b-42ad-8239-3a06a8b0a751",
            "name": "Groq Chat Model",
            "credentials": {
                "groqApi": {
                    "id": "ViSQoNpbR944gxu2",
                    "name": "Groq account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "let raw = $json.text || $json.choices?.[0]?.message?.content || JSON.stringify($json);\nconst start = raw.indexOf('{');\nconst end = raw.lastIndexOf('}');\nif (start !== -1 && end !== -1 && end > start) raw = raw.substring(start, end + 1);\ntry {\n  const parsed = JSON.parse(raw);\n  return [{ json: { ...$node[\"Merge Data\"].json, ...parsed } }];\n} catch (e) {\n  return [{ json: { ...$node[\"Merge Data\"].json, sentiment: \"neutral\", sentiment_score: 50, summary: \"Hata\", suggested_reply: \"Teknik sorun.\" } }];\n}"
            },
            "name": "Final Parser",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1400,
                240
            ],
            "id": "c698b1d0-faeb-4633-9d8c-206853e05439"
        },
        {
            "parameters": {
                "operation": "appendOrUpdate",
                "documentId": {
                    "__rl": true,
                    "value": "1CcQbucGVUjc-KT4O4noLwQ8dTJVdBR8qQ8loJkdWS7I",
                    "mode": "list"
                },
                "sheetName": {
                    "__rl": true,
                    "value": "gid=0",
                    "mode": "list"
                },
                "columns": {
                    "mappingMode": "defineBelow",
                    "value": {
                        "Name": "={{ $json.name }}",
                        "Timestamp": "={{ new Date().toISOString() }}",
                        "Email": "={{ $json.email }}",
                        "Review": "={{ $json.review }}",
                        "Sentiment": "={{ $json.sentiment }}",
                        "Score": "={{ $json.sentiment_score }}",
                        "Summary": "={{ $json.summary }}",
                        "Suggested_Reply": "={{ $json.suggested_reply }}"
                    },
                    "matchingColumns": [
                        "Timestamp"
                    ]
                }
            },
            "name": "Final Save",
            "type": "n8n-nodes-base.googleSheets",
            "typeVersion": 4,
            "position": [
                1600,
                240
            ],
            "id": "597750d0-a7a5-4dc9-9237-68a53f56bc1d",
            "credentials": {
                "googleSheetsOAuth2Api": {
                    "id": "wqKil85WMWsXWztO",
                    "name": "Google Sheets account"
                }
            }
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ $json }}",
                "options": {
                    "responseHeaders": {
                        "entries": [
                            {
                                "name": "Access-Control-Allow-Origin",
                                "value": "*"
                            }
                        ]
                    }
                }
            },
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1.4,
            "position": [
                1800,
                240
            ],
            "id": "1a82d9f1-b7bd-4d8e-acc3-90172ce7ad87",
            "name": "Respond to Webhook"
        },
        {
            "parameters": {
                "jsCode": "return [{\n  json: {\n    total: 120,\n    avgScore: 78,\n    positive: { percent: 85 }\n  }\n}];"
            },
            "name": "Mock Stats Info",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                400,
                500
            ],
            "id": "mock-stats-node"
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ $json }}",
                "options": {
                    "responseHeaders": {
                        "entries": [
                            {
                                "name": "Access-Control-Allow-Origin",
                                "value": "*"
                            }
                        ]
                    }
                }
            },
            "name": "Respond Stats",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                600,
                500
            ],
            "id": "respond-stats-node"
        },
        {
            "parameters": {
                "httpMethod": "OPTIONS",
                "path": "stats",
                "responseMode": "responseNode",
                "options": {}
            },
            "name": "Preflight Stats Options",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2,
            "position": [
                200,
                650
            ],
            "id": "preflight-stats-options-node",
            "webhookId": "stats"
        },
        {
            "parameters": {
                "respondWith": "text",
                "responseBody": "OK",
                "options": {
                    "responseHeaders": {
                        "entries": [
                            {
                                "name": "Access-Control-Allow-Origin",
                                "value": "*"
                            },
                            {
                                "name": "Access-Control-Allow-Headers",
                                "value": "Content-Type, ngrok-skip-browser-warning"
                            },
                            {
                                "name": "Access-Control-Allow-Methods",
                                "value": "GET, OPTIONS"
                            }
                        ]
                    }
                }
            },
            "name": "Respond Stats Preflight",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                400,
                650
            ],
            "id": "respond-stats-preflight-node"
        }
    ],
    "connections": {
        "Webhook": {
            "main": [
                [
                    {
                        "node": "Save Original Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Preflight Options": {
            "main": [
                [
                    {
                        "node": "Respond Preflight",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Save Original Data": {
            "main": [
                [
                    {
                        "node": "Lookup History",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Merge Data",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Knowledge Base (FAQ)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Knowledge Base (FAQ)": {
            "main": [
                [
                    {
                        "node": "Merge Data",
                        "type": "main",
                        "index": 2
                    }
                ]
            ]
        },
        "Lookup History": {
            "main": [
                [
                    {
                        "node": "Format History",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format History": {
            "main": [
                [
                    {
                        "node": "Merge Data",
                        "type": "main",
                        "index": 1
                    }
                ]
            ]
        },
        "Merge Data": {
            "main": [
                [
                    {
                        "node": "Basic LLM Chain",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Groq Chat Model": {
            "ai_languageModel": [
                [
                    {
                        "node": "Basic LLM Chain",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "Basic LLM Chain": {
            "main": [
                [
                    {
                        "node": "Final Parser",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Final Parser": {
            "main": [
                [
                    {
                        "node": "Final Save",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Final Save": {
            "main": [
                [
                    {
                        "node": "Respond to Webhook",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Stats Webhook": {
            "main": [
                [
                    {
                        "node": "Mock Stats Info",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Mock Stats Info": {
            "main": [
                [
                    {
                        "node": "Respond Stats",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Preflight Stats Options": {
            "main": [
                [
                    {
                        "node": "Respond Stats Preflight",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}